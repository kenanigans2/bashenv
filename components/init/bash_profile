#!/usr/bin/env bash
# USER BASH PROFILE (~/.bash_profile)

## SET `$bashenv' VARIABLE with path to project directory
##
{
    [[ "${1:-}" == '-v' ]] \
        && echo "USER BASH PROFILE SOURCED (~/.bash_profile)"
}

## LOCATION OF BASHENV REPOSITORY ROOT DIRECTORY
##  -> ~/Developer/bashenv
{
    [[ -z "${bashenv:-}" ]] \
        && [[ -d "${HOME}/Developer/bashenv" ]] \
        && declare -xr bashenv="${HOME}/Developer/bashenv"
    [[ -z "${scripts:-}" ]] \
        && [[ -d "${bashenv}/scripts" ]] \
        && declare -xr scripts="${bashenv}/scripts"

    [[ -r ~/.profile ]] && . ~/.profile
    [[ -r ~/.bashrc ]] && . ~/.bashrc
}

## CONFIGURE HISTORY
##
{
    __verify_hist_file_locations ()
    {
        local varname original_path new_path
        varname="${1:?}" original_path="${2:?}" new_path="${3:?}"

        [[ ! -f "${new_path:-}" ]] \
            && touch "${new_path}"

        [[ -z "${!varname:-}" ]] \
            && eval "export \"${varname}\"=\"${new_path}\""

        if [[ -f "${original_path}" ]]; then
            trap '[ -f "${original_path}" ] && rm "${original_path}"' RETURN HUP
            [ -s "${original_path}" ] \
                && cat "${original_path}" >> "${new_path}"
        fi
        return
    }

    [[ ! -d ~/.history ]] \
        && mkdir ~/.history

    [[ -f ~/.bash_history ]] \
        && cat ~/.bash_history >> ~/.history/bash_history \
        && rm ~/.bash_history

    export HISTSIZE=10000
    export HISTFILESIZE=10000
    export HISTCONTROL=ignoreboth
    export HISTIGNORE=c:h:j:x:clear:history:jobs:exit

    __verify_hist_file_locations MYSQL_HISTFILE ~/.{,history/}mysql_history
    __verify_hist_file_locations LESSHISTFILE ~/.lesshst ~/.history/less_history
    __verify_hist_file_locations MYCLI_HISTFILE ~/.mycli-history ~/.history/mycli_history
    __verify_hist_file_locations PYTHON_HISTFILE ~/.python_history ~/.history/python_history
    unset -f __verify_hist_file_locations
}

## PROMPT - PROMPT_COMMAND
##
{
    if ! declare -F ps1_command &> /dev/null; then
        ps1_command ()
        {
            local -ir xit=$?
            if ((xit != 0)); then
                echo -e "\\n\\t[[31;1m${xit}[0;0m]\\n"
            else
                echo
            fi
            return ${xit}
        }
    fi

    if ! echo "${PROMPT_COMMAND:-}" | grep -q 'ps1_command'; then
        export PROMPT_COMMAND="ps1_command${PROMPT_COMMAND:+; $PROMPT_COMMAND}"
    fi

}

## SHELL OPTIONS
##
{
    shopt -s cdable_vars extglob globstar
}

## OTHER ENV VARS
##
{
    [[ -f ~/mbox ]] \
        && /bin/ls -ldO ~/mbox \
            | grep -q hidden \
        || chflags hidden ~/mbox

    if ! echo "${PATH}" | grep -q "${HOME}/bin"; then
        [[ ! -d ~/bin ]] && mkdir ~/bin
        PATH="${HOME}/bin${PATH:+:$PATH}"
    fi

    if ! echo "${PATH}" | grep -q "/usr/local/sbin"; then
        PATH="/usr/local/sbin${PATH:+:$PATH}"
    fi

    export CDPATH=.:${HOME}
    export GLOBIGNORE=.DS_Store:.CFUserTextEncoding:.localized:.Trash
}

## BASHDB
##
if [[ -s "${bashenv:?}/.private" ]]; then
    source "${bashenv}/.private"
fi

